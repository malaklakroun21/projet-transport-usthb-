{% extends 'main.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/driver.css' %}" />
<style>
    .tour-header {
        background: white;
        border-radius: 12px;
        padding: 24px;
        margin-bottom: 24px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .tour-header-top {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 20px;
    }
    .tour-title {
        font-size: 1.5rem;
        font-weight: bold;
        color: #1e293b;
    }
    .tour-actions { display: flex; gap: 8px; }
    .tour-info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
    }
    .info-item { display: flex; flex-direction: column; }
    .info-item .label { font-size: 0.85rem; color: #64748b; margin-bottom: 4px; }
    .info-item .value { font-size: 1rem; font-weight: 500; color: #1e293b; }
    .status-badge { padding: 6px 16px; border-radius: 20px; font-size: 0.9rem; font-weight: 500; }
    .status-pending { background: #fef3c7; color: #92400e; }
    .status-in_progress { background: #dbeafe; color: #1e40af; }
    .status-completed { background: #d1fae5; color: #065f46; }
    .status-cancelled { background: #fee2e2; color: #991b1b; }
    .expeditions-section {
        background: white;
        border-radius: 12px;
        padding: 24px;
        margin-bottom: 24px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
    }
    .section-title { font-size: 1.2rem; font-weight: 600; color: #1e293b; }
    .add-expedition-form { display: flex; gap: 8px; }
    .add-expedition-form select {
        flex: 1;
        padding: 8px 12px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
    }
    .expedition-card {
        background: #f8fafc;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 12px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .expedition-info { flex: 1; }
    .expedition-tracking { font-weight: 600; color: #2563eb; }
    .expedition-meta { font-size: 0.85rem; color: #64748b; margin-top: 4px; }
    .incident-alert {
        background: #fef3c7;
        border: 1px solid #fcd34d;
        border-radius: 8px;
        padding: 12px 16px;
        margin-top: 16px;
    }
    .incident-alert.danger { background: #fee2e2; border-color: #fca5a5; }
</style>
{% endblock %}

{% block content %}
<section class="clients-page">
    <div style="margin-bottom: 16px;">
        <a href="{% url 'tour:list' %}" class="btn small">← Retour aux tournées</a>
    </div>

    <!-- Tour Header -->
    <div class="tour-header">
        <div class="tour-header-top">
            <div>
                <h2 class="tour-title">Tournée #{{ tour.id_tour }}</h2>
                <span class="status-badge status-{{ tour.status }}">{{ tour.get_status_display }}</span>
            </div>
            <div class="tour-actions">
                {% if tour.status == 'pending' %}
                <form method="POST" action="{% url 'tour:start' tour.pk %}" style="display:inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn primary">
                        <i class="fa fa-play"></i> Démarrer
                    </button>
                </form>
                {% elif tour.status == 'in_progress' %}
                <a href="{% url 'tour:complete' tour.pk %}" class="btn success">
                    <i class="fa fa-check"></i> Terminer
                </a>
                {% endif %}
                <a href="{% url 'tour:update' tour.pk %}" class="btn">
                    <i class="fa fa-edit"></i> Modifier
                </a>
            </div>
        </div>

        <div class="tour-info-grid">
            <div class="info-item">
                <span class="label">Date</span>
                <span class="value">{{ tour.tour_date|date:"d/m/Y"|default:"Non définie" }}</span>
            </div>
            <div class="info-item">
                <span class="label">Chauffeur</span>
                <span class="value">{{ tour.id_driver|default:"Non assigné" }}</span>
            </div>
            <div class="info-item">
                <span class="label">Véhicule</span>
                <span class="value">{{ tour.id_vehicle.immatriculation|default:"Non assigné" }}</span>
            </div>
            <div class="info-item">
                <span class="label">Horaires</span>
                <span class="value">{{ tour.starting_hour|time:"H:i"|default:"--:--" }} - {{ tour.finishing_hour|time:"H:i"|default:"--:--" }}</span>
            </div>
            <div class="info-item">
                <span class="label">Kilométrage</span>
                <span class="value">{{ tour.kilometers|floatformat:1|default:"0" }} km</span>
            </div>
            <div class="info-item">
                <span class="label">Carburant</span>
                <span class="value">{{ tour.fuel_consumption|floatformat:1|default:"0" }} L</span>
            </div>
            <div class="info-item">
                <span class="label">Poids total</span>
                <span class="value">{{ tour.total_weight|floatformat:1 }} kg</span>
            </div>
            <div class="info-item">
                <span class="label">Volume total</span>
                <span class="value">{{ tour.total_volume|floatformat:2 }} m³</span>
            </div>
        </div>

        {% if tour.has_delay %}
        <div class="incident-alert">
            <strong><i class="fa fa-clock"></i> Retard signalé:</strong> {{ tour.delay_minutes }} minutes
        </div>
        {% endif %}

        {% if tour.has_technical_issue %}
        <div class="incident-alert danger">
            <strong><i class="fa fa-exclamation-triangle"></i> Problème technique:</strong> {{ tour.technical_issue_description|default:"Non spécifié" }}
        </div>
        {% endif %}

        {% if tour.comments %}
        <div style="margin-top: 16px;">
            <strong>Commentaires:</strong>
            <p style="color: #64748b;">{{ tour.comments }}</p>
        </div>
        {% endif %}
    </div>

    <!-- Expeditions Section -->
    <div class="expeditions-section">
        <div class="section-header">
            <h3 class="section-title">Expéditions ({{ tour_expeditions.count }})</h3>
            {% if tour.status == 'pending' %}
            <form method="POST" action="{% url 'tour:add_expedition' tour.pk %}" class="add-expedition-form">
                {% csrf_token %}
                {{ add_form.expedition }}
                <button type="submit" class="btn primary">
                    <i class="fa fa-plus"></i> Ajouter
                </button>
            </form>
            {% endif %}
        </div>

        {% for te in tour_expeditions %}
        <div class="expedition-card">
            <div class="expedition-info">
                <span class="expedition-tracking">{{ te.expedition.tracking_number }}</span>
                <div class="expedition-meta">
                    <strong>Client:</strong> {{ te.expedition.id_client|default:"-" }} |
                    <strong>Destination:</strong> {{ te.expedition.id_destination|default:"-" }} |
                    <strong>Poids:</strong> {{ te.expedition.weight|floatformat:1 }} kg |
                    <strong>Statut:</strong> {{ te.expedition.get_status_display }}
                    {% if te.delivered %}<span style="color: #059669;"> ✓ Livrée</span>{% endif %}
                </div>
            </div>
            <div>
                {% if tour.status == 'pending' %}
                <a href="{% url 'tour:remove_expedition' tour.pk te.expedition.pk %}" class="btn small danger">
                    <i class="fa fa-times"></i> Retirer
                </a>
                {% endif %}
                <a href="{% url 'expedition_detail' te.expedition.pk %}" class="btn small">
                    <i class="fa fa-eye"></i>
                </a>
            </div>
        </div>
        {% empty %}
        <p style="text-align: center; color: #64748b; padding: 24px;">
            Aucune expédition assignée à cette tournée.
            {% if tour.status == 'pending' %}Utilisez le formulaire ci-dessus pour ajouter des expéditions.{% endif %}
        </p>
        {% endfor %}
    </div>
</section>
{% endblock %}
